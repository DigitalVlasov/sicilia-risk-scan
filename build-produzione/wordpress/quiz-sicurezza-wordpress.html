<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Test di conformità sicurezza lavoro gratuito. Valuta i rischi della tua azienda secondo D.Lgs. 81/08 aggiornato 2025. Analisi gratuita con Spazio Impresa.">
    <meta name="keywords" content="sicurezza lavoro, D.Lgs 81/08, test conformità, DVR, formazione sicurezza, valutazione rischi">
    <meta name="author" content="Spazio Impresa">
    <meta name="robots" content="index, follow">
    <meta name="language" content="it">
    <meta property="og:title" content="Test Sicurezza Lavoro Gratuito - Spazio Impresa">
    <meta property="og:description" content="Scopri i rischi della tua azienda in 3 minuti. Test basato su D.Lgs. 81/08 aggiornato 2025.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    
    <title>Test Sicurezza Lavoro Gratuito - Spazio Impresa</title>
    
    <style>
        /* ========== DESIGN SYSTEM COLORS (HSL) ========== */
        :root {
            /* Base Colors */
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            
            /* Card Colors */
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            
            /* Popover Colors */
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            
            /* Primary Colors */
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            
            /* Secondary Colors */
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            
            /* Muted Colors */
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            
            /* Accent Colors */
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            
            /* Destructive Colors */
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            
            /* Border Colors */
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            
            /* CTA Colors */
            --cta: 120 100% 25%;
            --cta-foreground: 0 0% 100%;
            --cta-light: 120 100% 95%;
            
            /* Gradients */
            --gradient-hero: linear-gradient(135deg, hsl(var(--primary)), hsl(222.2 84% 15%));
            --gradient-soft: linear-gradient(180deg, hsl(var(--background)), hsl(210 40% 98%));
            --gradient-tech: linear-gradient(135deg, hsl(220 100% 10%), hsl(230 100% 5%));
            
            /* Shadows */
            --shadow-elegant: 0 10px 30px -10px hsl(var(--primary) / 0.3);
            --shadow-glow: 0 0 40px hsl(var(--primary) / 0.2);
            
            /* Animations */
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Border Radius */
            --radius: 0.5rem;
        }
        
        /* Dark mode variables */
        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 210 40% 98%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
        }
        
        /* ========== BASE STYLES ========== */
        * {
            border-color: hsl(var(--border));
            box-sizing: border-box;
        }
        
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: "Roboto", ui-sans-serif, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ========== UTILITY CLASSES ========== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .space-y-4 > * + * {
            margin-top: 1rem;
        }
        
        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .gap-3 {
            gap: 0.75rem;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-left {
            text-align: left;
        }
        
        .text-right {
            text-align: right;
        }
        
        .hidden {
            display: none;
        }
        
        .block {
            display: block;
        }
        
        .inline-block {
            display: inline-block;
        }
        
        .w-full {
            width: 100%;
        }
        
        .h-full {
            height: 100%;
        }
        
        .min-h-screen {
            min-height: 100vh;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .p-6 {
            padding: 1.5rem;
        }
        
        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        
        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mt-3 {
            margin-top: 0.75rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mt-6 {
            margin-top: 1.5rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-3 {
            margin-bottom: 0.75rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .rounded {
            border-radius: calc(var(--radius) - 2px);
        }
        
        .rounded-lg {
            border-radius: var(--radius);
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        .border {
            border-width: 1px;
        }
        
        .border-2 {
            border-width: 2px;
        }
        
        .border-red-600 {
            border-color: hsl(0 84.2% 60.2%);
        }
        
        .border-black {
            border-color: hsl(0 0% 0%);
        }
        
        .border-gray-200 {
            border-color: hsl(210 40% 92%);
        }
        
        .border-gray-300 {
            border-color: hsl(210 40% 88%);
        }
        
        .bg-white {
            background-color: hsl(0 0% 100%);
        }
        
        .bg-gray-50 {
            background-color: hsl(210 40% 98%);
        }
        
        .bg-gray-100 {
            background-color: hsl(210 40% 96%);
        }
        
        .bg-gray-800 {
            background-color: hsl(217.2 32.6% 17.5%);
        }
        
        .bg-red-50 {
            background-color: hsl(0 100% 97%);
        }
        
        .bg-red-100 {
            background-color: hsl(0 100% 95%);
        }
        
        .bg-green-50 {
            background-color: hsl(120 100% 97%);
        }
        
        .bg-green-100 {
            background-color: hsl(120 100% 95%);
        }
        
        .bg-green-600 {
            background-color: hsl(120 100% 25%);
        }
        
        .bg-yellow-100 {
            background-color: hsl(54 100% 95%);
        }
        
        .bg-orange-100 {
            background-color: hsl(24 100% 95%);
        }
        
        .text-white {
            color: hsl(0 0% 100%);
        }
        
        .text-black {
            color: hsl(0 0% 0%);
        }
        
        .text-gray-600 {
            color: hsl(215.4 16.3% 46.9%);
        }
        
        .text-gray-700 {
            color: hsl(215.4 16.3% 36.9%);
        }
        
        .text-red-600 {
            color: hsl(0 84.2% 60.2%);
        }
        
        .text-red-800 {
            color: hsl(0 84.2% 30%);
        }
        
        .text-green-800 {
            color: hsl(120 100% 20%);
        }
        
        .text-yellow-800 {
            color: hsl(54 100% 20%);
        }
        
        .text-orange-800 {
            color: hsl(24 100% 20%);
        }
        
        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .text-base {
            font-size: 1rem;
            line-height: 1.5rem;
        }
        
        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        
        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }
        
        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }
        
        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        .transition-colors {
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .transition-transform {
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .hover\:bg-gray-100:hover {
            background-color: hsl(210 40% 96%);
        }
        
        .hover\:bg-green-700:hover {
            background-color: hsl(120 100% 20%);
        }
        
        .hover\:text-black:hover {
            color: hsl(0 0% 0%);
        }
        
        .hover\:scale-105:hover {
            transform: scale(1.05);
        }
        
        /* ========== ANIMATIONS ========== */
        @keyframes fade-in {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scale-in {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                animation-timing-function: cubic-bezier(0.755, 0.05, 0.855, 0.06);
                transform: translate3d(0, -30px, 0);
            }
            70% {
                animation-timing-function: cubic-bezier(0.755, 0.05, 0.855, 0.06);
                transform: translate3d(0, -15px, 0);
            }
            90% {
                transform: translate3d(0, -4px, 0);
            }
        }
        
        .animate-enter {
            animation: fade-in 0.3s ease-out, scale-in 0.2s ease-out;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        .hover-scale {
            transition: transform 0.2s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
        
        /* ========== COMPONENT STYLES ========== */
        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        .card-header {
            padding: 1.5rem 1.5rem 0;
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        .card-title {
            font-size: 1.5rem;
            line-height: 2rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            padding: 0.5rem 1rem;
            min-height: 2.25rem;
            text-decoration: none;
        }
        
        .button:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }
        
        .button:disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        
        .button-default {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .button-default:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        .button-ghost {
            background-color: transparent;
            color: hsl(var(--foreground));
        }
        
        .button-ghost:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        
        .button-cta {
            background-color: hsl(var(--cta));
            color: hsl(var(--cta-foreground));
            font-weight: 600;
        }
        
        .button-cta:hover {
            background-color: hsl(var(--cta) / 0.9);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.125rem 0.625rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .badge-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }
        
        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: hsl(var(--secondary));
            border-radius: 9999px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: hsl(var(--primary));
            transition: width 0.3s ease;
            border-radius: 9999px;
        }
        
        .select {
            display: flex;
            height: 2.5rem;
            width: 100%;
            align-items: center;
            justify-content: between;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--input));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        .select:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }
        
        .select-content {
            position: absolute;
            z-index: 50;
            min-width: 8rem;
            overflow: hidden;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--popover));
            color: hsl(var(--popover-foreground));
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-top: 0.25rem;
        }
        
        .select-item {
            position: relative;
            display: flex;
            width: 100%;
            cursor: pointer;
            align-items: center;
            border-radius: calc(var(--radius) - 4px);
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
            outline: none;
        }
        
        .select-item:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        
        .accordion-item {
            border-bottom: 1px solid hsl(var(--border));
        }
        
        .accordion-trigger {
            display: flex;
            flex: 1;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
        }
        
        .accordion-trigger:hover {
            text-decoration: underline;
        }
        
        .accordion-content {
            overflow: hidden;
            font-size: 0.875rem;
            transition: all 0.2s ease-out;
        }
        
        .accordion-content-inner {
            padding: 0 0 1rem 0;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 640px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .text-2xl {
                font-size: 1.25rem;
                line-height: 1.75rem;
            }
            
            .text-3xl {
                font-size: 1.5rem;
                line-height: 2rem;
            }
            
            .p-6 {
                padding: 1rem;
            }
            
            .card-header {
                padding: 1rem 1rem 0;
            }
            
            .card-content {
                padding: 1rem;
            }
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        
        .grid {
            display: grid;
        }
        
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        
        .overflow-hidden {
            overflow: hidden;
        }
        
        .whitespace-nowrap {
            white-space: nowrap;
        }
        
        .text-ellipsis {
            text-overflow: ellipsis;
        }
        
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .border-l-4 {
            border-left-width: 4px;
        }
        
        .border-red-500 {
            border-color: hsl(0 84.2% 60.2%);
        }
        
        .border-green-500 {
            border-color: hsl(120 100% 25%);
        }
        
        .border-red-300 {
            border-color: hsl(0 84.2% 80%);
        }
        
        .border-green-300 {
            border-color: hsl(120 100% 80%);
        }
        
        .border-yellow-300 {
            border-color: hsl(54 100% 80%);
        }
        
        .border-orange-300 {
            border-color: hsl(24 100% 80%);
        }
        
        .flex-1 {
            flex: 1 1 0%;
        }
        
        .flex-shrink-0 {
            flex-shrink: 0;
        }
        
        .min-w-0 {
            min-width: 0px;
        }
        
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }
        
        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
        }
        
        .from-gray-900 {
            --tw-gradient-from: hsl(220 13% 13%);
            --tw-gradient-to: hsl(220 13% 13% / 0);
            --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to);
        }
        
        .to-black {
            --tw-gradient-to: hsl(0 0% 0%);
        }
        
        .bg-white\/10 {
            background-color: hsl(0 0% 100% / 0.1);
        }
        
        .bg-white\/20 {
            background-color: hsl(0 0% 100% / 0.2);
        }
        
        .border-white\/20 {
            border-color: hsl(0 0% 100% / 0.2);
        }
        
        .border-gray-700 {
            border-color: hsl(217.2 32.6% 17.5%);
        }
        
        .text-gray-300 {
            color: hsl(212.7 26.8% 83.9%);
        }
        
        .border-t {
            border-top-width: 1px;
        }
        
        .border-b {
            border-bottom-width: 1px;
        }
        
        .pb-2 {
            padding-bottom: 0.5rem;
        }
        
        .pb-4 {
            padding-bottom: 1rem;
        }
        
        .pt-2 {
            padding-top: 0.5rem;
        }
        
        .space-y-1 > * + * {
            margin-top: 0.25rem;
        }
        
        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }
        
        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }
        
        .mr-1 {
            margin-right: 0.25rem;
        }
        
        .w-6 {
            width: 1.5rem;
        }
        
        .h-6 {
            height: 1.5rem;
        }
        
        .w-8 {
            width: 2rem;
        }
        
        .h-8 {
            height: 2rem;
        }
        
        .items-start {
            align-items: flex-start;
        }
        
        .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }
        
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div id="quiz-container" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 py-4">
            <div class="container">
                <div class="flex items-center justify-center">
                    <img src="/wp-content/uploads/spazio-impresa-logo.png" alt="Spazio Impresa Logo" class="h-8">
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4">
            <div class="container space-y-6">
                <!-- Progress Bar -->
                <div id="progress-container" class="hidden">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Intro Stage -->
                <div id="intro-stage" class="text-center space-y-6">
                    <h1 class="text-3xl font-bold">Test di Conformità Sicurezza Lavoro</h1>
                    <p class="text-lg text-gray-600">Scopri in 3 minuti i potenziali rischi della tua azienda secondo il D.Lgs. 81/08 aggiornato 2025</p>
                    
                    <div class="card max-w-2xl mx-auto">
                        <div class="card-content">
                            <h2 class="text-xl font-semibold mb-4">📋 Cosa scoprirai:</h2>
                            <ul class="text-left space-y-2">
                                <li>✅ Il livello di rischio attuale della tua azienda</li>
                                <li>📊 Le potenziali sanzioni in caso di controllo ispettivo</li>
                                <li>🎯 Le azioni specifiche per metterti in sicurezza</li>
                                <li>💡 Analisi personalizzata gratuita con i nostri esperti</li>
                            </ul>
                            
                            <div class="mt-6">
                                <button id="start-quiz" class="button button-cta w-full py-4 text-lg hover-scale">
                                    🚀 Inizia il Test Gratuito
                                </button>
                                <p class="text-xs text-gray-500 mt-2">
                                    ⏱️ Tempo stimato: 3 minuti • 📱 100% mobile friendly
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Stage -->
                <div id="quiz-stage" class="hidden">
                    <div id="question-card" class="card animate-enter max-w-2xl mx-auto">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span id="question-number" class="text-gray-600">Domanda 1 di 8</span>
                                <div id="question-title" class="mt-1 text-xl"></div>
                                <div id="question-subtitle" class="text-sm text-gray-600 mt-2"></div>
                            </h2>
                        </div>
                        <div class="card-content">
                            <div id="question-options" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Loading Stage -->
                <div id="loading-stage" class="hidden text-center space-y-6">
                    <div class="card max-w-2xl mx-auto">
                        <div class="card-content text-center">
                            <div class="text-6xl mb-4">⚙️</div>
                            <h2 class="text-xl font-semibold mb-4">Stiamo elaborando i tuoi risultati...</h2>
                            <div class="progress-bar mb-4">
                                <div id="loading-progress" class="progress-fill" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600">
                                Analizzando le tue risposte secondo i protocolli ispettivi 2025
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Results Stage -->
                <div id="results-stage" class="hidden space-y-6">
                    <!-- Results content will be dynamically generated -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-50 border-t border-gray-200 py-4">
            <div class="container text-center">
                <p class="text-xs text-gray-600">
                    Test basato su D.Lgs. 81/08 aggiornato 2025 e protocolli ispettivi INL/ASP/SPRESAL Sicilia 2025 • 
                    <strong>Spazio Impresa</strong> © 2025 • 
                    Tel: 095 587 2480
                </p>
            </div>
        </footer>
    </div>

    <script>
        // ========== CONFIGURATION DATA ==========
        const APP_CONFIG = {
            version: "2025",
            contact: {
                phone: "0955872480",
                whatsapp: "390955872480"
            },
            ui: {
                loadingDelay: 800,
                transitionDelay: 200
            },
            legal: {
                framework: "D.Lgs. 81/08 aggiornato 2025",
                source: "protocolli ispettivi INL/ASP/SPRESAL Sicilia 2025",
                disclaimer: "Test basato su D.Lgs. 81/08 aggiornato 2025 e protocolli ispettivi INL/ASP/SPRESAL Sicilia 2025"
            }
        };

        const QUIZ_QUESTIONS = [
            {
                id: "gestione",
                title: "Come gestisci attualmente la sicurezza aziendale?",
                subtitle: "Scegli l'opzione più vicina alla tua realtà",
                type: "multiplier",
                options: [
                    { value: "gestisco-io", label: "Gestisco io personalmente", multiplier: 1.5 },
                    { value: "interno", label: "Persona dedicata internamente", multiplier: 1.3 },
                    { value: "consulente", label: "Consulente specializzato", multiplier: 1 },
                    { value: "studi-multipli", label: "Diversi professionisti", multiplier: 1.2 }
                ]
            },
            {
                id: "dipendenti", 
                title: "Quanti dipendenti ha la tua azienda?",
                subtitle: "Scegli l'opzione più vicina alla tua realtà",
                type: "multiplier",
                options: [
                    { value: "1-5", label: "1-5 dipendenti", multiplier: 1 },
                    { value: "6-10", label: "6-10 dipendenti", multiplier: 1.3 },
                    { value: "11-20", label: "11-20 dipendenti", multiplier: 1.8 },
                    { value: ">20", label: "Oltre 20 dipendenti", multiplier: 2.2 }
                ]
            },
            {
                id: "settore",
                title: "In quale settore opera principalmente la tua azienda?",
                subtitle: "Scegli l'opzione più vicina alla tua realtà",
                type: "multiplier",
                options: [
                    { value: "edilizia", label: "Edilizia/Impiantistica", multiplier: 2 },
                    { value: "manifatturiero", label: "Manifatturiero/Produzione", multiplier: 1.6 },
                    { value: "alimentare", label: "Alloggio/Ristorazione", multiplier: 1.5 },
                    { value: "agricoltura", label: "Agricoltura/Allevamento", multiplier: 1.6 },
                    { value: "trasporto", label: "Trasporto/Magazzinaggio", multiplier: 1.7 },
                    { value: "commercio", label: "Commercio/Retail", multiplier: 1.2 },
                    { value: "servizi", label: "Servizi/Consulenza", multiplier: 1.2 }
                ]
            },
            {
                id: "dvr",
                title: "L'ispettore ti dice: «Fammi vedere DVR aggiornato, nomine SPP e verbali riunioni». Hai tutto pronto?",
                subtitle: "Primo controllo sempre richiesto - Fonte: 859 ispezioni ASP Catania 2024",
                type: "score",
                options: [
                    { value: "si", label: "Sì, tutto pronto", weight: 0 },
                    { value: "no", label: "No, manca qualcosa", weight: 3 },
                    { value: "non-sicuro", label: "Non sono sicuro", weight: 2 }
                ]
            },
            {
                id: "formazione",
                title: "L'ispettore controlla 3 dipendenti a caso + il datore di lavoro: trovi tutti gli attestati validi?",
                subtitle: "Novità 2025: include obbligo formazione datori 16 ore (Accordo Stato-Regioni)",
                type: "score",
                options: [
                    { value: "si", label: "Sì, attestati validi", weight: 0 },
                    { value: "no", label: "No, alcuni mancano", weight: 3 },
                    { value: "non-sicuro", label: "Non sono sicuro", weight: 2 }
                ]
            },
            {
                id: "sorveglianza",
                title: "Sorveglianza sanitaria: Riesci a reperire i Giudizi di Idoneità ultimi 2 anni, Protocollo Sanitario e Nomina del Medico Competente aggiornata?",
                subtitle: "Controllo cartelle mediche sempre verificato",
                type: "score",
                options: [
                    { value: "si", label: "Sì, tutto aggiornato", weight: 0 },
                    { value: "no", label: "No, mancano visite", weight: 2 },
                    { value: "non-gestisco", label: "Non gestisco personalmente", weight: 1 }
                ]
            },
            {
                id: "emergenze",
                title: "Piano Emergenza ed Evacuazione, nomine figure aziendali sulla sicurezza: tutto a posto?",
                subtitle: "Due controlli prioritari sempre verificati insieme",
                type: "score",
                options: [
                    { value: "si", label: "Sì, tutto organizzato", weight: 0 },
                    { value: "no", label: "No, mancano procedure", weight: 2 },
                    { value: "non-sicuro", label: "Non sono sicuro", weight: 1 }
                ]
            },
            {
                id: "patente-cantieri",
                title: "Hai la patente a punti o crediti nei cantieri edili, con almeno 15 punti attivi?",
                subtitle: "Obbligatoria dal 1° ottobre 2024 – in caso di mancanza si rischia sanzione amministrativa ed esclusione dalla partecipazione a lavori pubblici",
                type: "score",
                conditional: {
                    dependsOn: "settore",
                    showFor: ["edilizia"]
                },
                options: [
                    { value: "si", label: "Sì, ho la patente attiva", weight: 0 },
                    { value: "no", label: "No, non ce l'ho", weight: 4 },
                    { value: "non-sicuro", label: "Non sono sicuro", weight: 3 }
                ]
            }
        ];

        const VIOLATIONS_CONFIG = {
            dvr: {
                key: "dvr",
                text: "DVR e Nomine",
                min: 2894,
                max: 7404,
                consequences: [
                    "Sospensione immediata dell'attività in caso di controllo.",
                    "In caso di infortunio, rischi una denuncia per lesioni o omicidio colposo.",
                    "L'INAIL può negare la copertura assicurativa."
                ],
                actions: [
                    "Redigere/aggiornare il DVR con un tecnico qualificato.",
                    "Nominare formalmente RSPP e altre figure obbligatorie.",
                    "Verbalizzare la riunione periodica annuale."
                ],
                fonte: "D.Lgs. 81/08, art. 18 e 29 (sanzioni rivalutate 2025)",
                priority: { order: 1, urgency: "CRITICO" }
            },
            formazione: {
                key: "formazione",
                text: "Formazione Aggiornata",
                min: 1709,
                max: 7404,
                consequences: [
                    "Responsabilità penale diretta in caso di infortunio.",
                    "Nullità di incarichi chiave (RLS, addetti antincendio, etc.).",
                    "Dal 2025, la mancata formazione del Datore di Lavoro è violazione grave."
                ],
                actions: [
                    "Verificare immediatamente lo stato di tutti gli attestati.",
                    "Iscrivere il personale ai corsi di aggiornamento.",
                    "Pianificare il nuovo corso obbligatorio di 16 ore per il Datore di Lavoro."
                ],
                fonte: "D.Lgs. 81/08 art. 37 + Nuovo Accordo Stato-Regioni 2025",
                priority: { order: 2, urgency: "CRITICO" }
            },
            sorveglianza: {
                key: "sorveglianza",
                text: "Sorveglianza Sanitaria",
                min: 2316,
                max: 7632,
                consequences: [
                    "Un dipendente senza giudizio di idoneità valido non può legalmente lavorare.",
                    "Rischio di denuncia se un infortunio è correlato a una condizione non monitorata.",
                    "L'ASP può disporre la sospensione dell'attività."
                ],
                actions: [
                    "Nominare (o verificare) il Medico Competente.",
                    "Pianificare le visite mediche periodiche.",
                    "Assicurarsi che il protocollo sanitario sia aggiornato ai rischi del DVR."
                ],
                fonte: "D.Lgs. 81/08, Titolo I e X; Legge 203/2024",
                priority: { order: 3, urgency: "ALTO" }
            },
            emergenze: {
                key: "emergenze",
                text: "Gestione Emergenze",
                min: 1068,
                max: 5695,
                consequences: [
                    "In caso di incendio o infortunio, la mancata organizzazione ti rende penalmente responsabile.",
                    "Rischi l'arresto fino a 4 mesi se ci sono danni a persone.",
                    "Sanzioni immediate in assenza di nomine e prove di evacuazione."
                ],
                actions: [
                    "Aggiornare il piano di emergenza.",
                    "Nominare e formare addetti antincendio e primo soccorso.",
                    "Tenere un registro infortuni aggiornato."
                ],
                fonte: "D.Lgs. 81/08, Titolo I e II",
                priority: { order: 4, urgency: "ALTO" }
            },
            "patente-cantieri": {
                key: "patente-cantieri",
                text: "Patente a Crediti",
                min: 6000,
                max: 12000,
                consequences: [
                    "Impossibilità di operare in qualsiasi cantiere.",
                    "Esclusione automatica da gare e appalti.",
                    "Sanzione min. €6.000 e blocco immediato dell'attività."
                ],
                actions: [
                    "Richiedere la patente all'Ispettorato del Lavoro.",
                    "Verificare di avere almeno 15 crediti attivi.",
                    "Frequentare corsi per recuperare eventuali crediti persi."
                ],
                fonte: "D.L. 19/2024 (Decreto PNRR 4)",
                priority: { order: 1, urgency: "BLOCCANTE" }
            }
        };

        const CASE_STUDIES = [
            {
                id: 1,
                sector: "Alimentare",
                title: "Azienda Dolciaria - Provincia Catania",
                situation: "Controllo ispettivo in corso",
                challenge: "L'azienda aveva ricevuto un controllo ispettivo a sorpresa durante il periodo più critico dell'anno:\n\n• <strong>Sospensione immediata</strong> dell'attività produttiva\n• <strong>Perdite devastanti</strong> durante periodo natalizio (70% fatturato)\n• <strong>Sanzioni cumulative</strong> giornaliere per ogni documento mancante\n• <strong>Responsabilità penale</strong> diretta del datore di lavoro\n• <strong>Stop totale produzione</strong> senza conformità",
                solution: [
                    "<strong>Formazione Art. 37</strong> organizzata direttamente in azienda",
                    "Figure aziendali <strong>certificate</strong> tramite Ente Accreditato",
                    "Visite mediche coordinate in <strong>tempi record</strong>",
                    "<strong>DVR e Piano Emergenza</strong> consegnati chiavi in mano"
                ],
                result: "In <strong>20-25 giorni</strong> l'azienda ha presentato <strong>tutti i documenti richiesti</strong> ai funzionari",
                icon: "🍰"
            },
            {
                id: 2,
                sector: "Manifatturiero", 
                title: "PMI Metalmeccanica - Provincia Siracusa",
                situation: "Necessità formazione senza budget",
                challenge: "L'azienda aveva urgenti necessità di adeguamento normativo per il rinnovo degli attestati di formazione obbligatoria:\n\n• <strong>Spreco di tempo</strong> per ricerca enti accreditati\n• <strong>Costi elevati</strong> (€2.500+) non preventivati\n• <strong>Spreco di risorse</strong> nella coordinazione fornitori\n• <strong>Interruzioni produttive</strong> per pianificazione complessa\n• <strong>Zero controllo costi</strong> formativi",
                solution: [
                    "Accesso ai <strong>Fondi Interprofessionali</strong> per formazione gratuita",
                    "Erogazione di tutti i percorsi formativi <strong>obbligatori</strong>",
                    "<strong>Risparmio economico</strong> significativo sui costi di formazione",
                    "Personale completamente <strong>formato e certificato</strong>"
                ],
                result: "<strong>Risparmio di oltre €2.200</strong> sui costi di formazione standard",
                icon: "⚙️"
            },
            {
                id: 3,
                sector: "Tessile",
                title: "Azienda Confezioni - Provincia Messina", 
                situation: "AUDIT esterno imminente",
                challenge: "L'azienda doveva superare un AUDIT critico dal cliente principale che rappresentava il 70% del fatturato:\n\n• <strong>Perdita di commessa da milioni di euro</strong> in caso di fallimento\n• <strong>Chiusura potenziale</strong> dell'attività\n• <strong>Zero margine errore</strong> nelle richieste tecniche\n• <strong>Tempi strettissimi</strong> per adeguamento completo\n• <strong>Reputazione aziendale</strong> a rischio totale",
                solution: [
                    "<strong>Team multidisciplinare</strong> di specialisti coordinati",
                    "Piano Emergenza <strong>personalizzato</strong> per audit specifico", 
                    "DVR realizzato <strong>su misura</strong> per le richieste",
                    "<strong>Coordinamento completo</strong> di tutti i fornitori senza stress aggiuntivo",
                    "Supporto tecnico completo <strong>DPI ed estintori</strong>"
                ],
                result: "<strong>AUDIT superato con successo</strong> e commessa confermata per i prossimi 3 anni",
                icon: "👔"
            }
        ];

        // ========== QUIZ STATE MANAGEMENT ==========
        let quizState = {
            stage: "intro", // intro, quiz, loading, results
            currentQuestionIndex: 0,
            answers: {},
            baseScore: 0,
            multiplier: 1,
            filteredQuestions: []
        };

        // ========== UTILITY FUNCTIONS ==========
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function validateCSRF() {
            // In WordPress, this would be handled by wp_nonce
            return true; // Simplified for demo
        }

        function rateLimit() {
            // Implement rate limiting logic
            return true; // Simplified for demo
        }

        function escapeOutput(output) {
            return output.replace(/[&<>"']/g, function(match) {
                const escapeMap = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#x27;'
                };
                return escapeMap[match];
            });
        }

        // ========== QUIZ LOGIC ==========
        function filterQuestions(answers) {
            return QUIZ_QUESTIONS.filter(question => {
                if (!question.conditional) return true;
                
                const { dependsOn, showFor } = question.conditional;
                const dependentAnswer = answers[dependsOn];
                
                return dependentAnswer && showFor.includes(dependentAnswer);
            });
        }

        function calculateRisk(baseScore, multiplier) {
            const finalScore = Math.round(baseScore * multiplier);
            
            let level;
            if (finalScore <= 4) level = "Basso";
            else if (finalScore <= 8) level = "Medio";
            else level = "Alto";

            return { level, finalScore };
        }

        function calculateViolations(answers) {
            const foundViolations = [];
            
            for (const [key, violation] of Object.entries(VIOLATIONS_CONFIG)) {
                if (isViolationTriggered(key, answers)) {
                    foundViolations.push(violation);
                }
            }
            
            return foundViolations.sort((a, b) => a.priority.order - b.priority.order);
        }

        function isViolationTriggered(key, answers) {
            const answer = answers[key];
            if (!answer) return false;
            
            const negativeAnswers = ["no", "non-sicuro", "non-gestisco"];
            return negativeAnswers.includes(answer);
        }

        function getSectorName(sector) {
            const sectorNames = {
                edilizia: "Edilizia",
                alimentare: "Alloggio/Ristorazione",
                manifatturiero: "Manifatturiero",
                servizi: "Servizi",
                commercio: "Commercio",
                agricoltura: "Agricoltura",
                trasporto: "Trasporto/Magazzinaggio"
            };
            return sectorNames[sector] || "Servizi";
        }

        function generateDynamicInsight(answers, violations) {
            const sector = answers.settore;
            const management = answers.gestione;
            
            if (violations.length === 0) {
                return generateExcellenceInsight(sector, management);
            } else {
                return generateImprovementInsight(sector, management, violations.length);
            }
        }

        function generateExcellenceInsight(sector, management) {
            const sectorNames = {
                edilizia: "di Edilizia",
                manifatturiero: "di Manifatturiero / Produzione", 
                alimentare: "di alloggio/ristorazione",
                trasporto: "di logistica",
                agricoltura: "di Agricoltura / Allevamento",
                commercio: "del commercio",
                servizi: "di Servizi / Uffici",
                ristorazione: "di Ristorazione / Commercio"
            };

            const sectorName = sectorNames[sector] || "del tuo settore";

            const excellenceTemplates = {
                "studi-multipli": {
                    title: "Complimenti, stai lavorando con i migliori!",
                    text: `La tua azienda nel settore ${sectorName} sembra ben strutturata dal punto di vista della sicurezza.

Sapevi che nel tuo settore solo il <strong>15% delle aziende</strong> ha questo tipo di risultati con una gestione multi-consulenza?

Spesso ciò che non viene detto è che affidarsi a più specialisti, invece di avere un coordinamento centralizzato, e stare dietro alle comunicazioni frammentate tra consulenti ti espone a:

• Nessuno si prende la responsabilità totale quando hai urgenza
• Ogni consulente conosce solo il suo pezzo del puzzle
• Le informazioni critiche si perdono tra un professionista e l'altro
• In caso di ispezione ogni consulente dice "non è competenza mia"

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per velocizzare i processi operativi</strong> mantenendo la specializzazione ma eliminando la frammentazione.`,
                    ctaText: "Confronta: specializzazione + coordinamento ottimale",
                    benefits: [
                        "Unico sistema, zero frammentazione.",
                        "Scadenze sotto controllo, rischio azzerato.", 
                        "Documenti sempre pronti per i controlli.",
                        "Nuovi assunti subito a norma, senza sforzi.",
                        "Formazione finanziata, costi ottimizzati."
                    ]
                },
                "consulente": {
                    title: "Ottima scelta, hai un professionista di fiducia!",
                    text: `La tua azienda nel settore ${sectorName} sembra ben strutturata dal punto di vista della sicurezza.

Sapevi che nel tuo settore solo il <strong>20% delle aziende</strong> ha questo tipo di risultati con consulenza esterna?

<strong>Spesso ciò che non viene detto è che dipendere da un solo consulente, significa stare dietro alle sue disponibilità:</strong>

• Quando hai un'urgenza, potrebbe non essere subito disponibile
• L'organizzazione generale dipende dalla sua agenda, non dalla tua
• In caso di ispezione, se non c'è lui potresti trovarti scoperto
• La gestione dei fondi formativi richiede la sua presenza continua

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per ottimizzare i costi</strong> mantenendo la professionalità esterna ma con accesso immediato a tutto.`,
                    ctaText: "Confronta: consulente + accesso immediato",
                    benefits: [
                        "Pieno controllo per te e il tuo consulente.",
                        "Scadenze e adempimenti sempre rispettati.",
                        "Documentazione a prova di ispezione, 24/7.",
                        "Gestione del personale semplice e conforme.",
                        "Costi di formazione ridotti con i fondi."
                    ]
                },
                "interno": {
                    title: "Fantastico, hai una risorsa dedicata!",
                    text: `La tua azienda nel settore ${sectorName} sembra ben strutturata dal punto di vista della sicurezza.

Sapevi che nel tuo settore solo il <strong>25% delle aziende</strong> ha questo tipo di risultati con risorse interne?

Spesso ciò che non viene detto è che caricare tutto su una persona, invece di supportarla con sistemi automatici, e stare dietro a tutti gli aggiornamenti normativi ti espone a:

• Quella persona è sempre in overload e rischia il burnout
• Deve essere esperta di tutto ma è impossibile rimanere sempre aggiornata
• Ogni aggiornamento normativo diventa una corsa contro il tempo
• Un errore umano può costare molto caro all'azienda

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per velocizzare i processi operativi</strong> mantenendo il controllo diretto ma alleggerendo significativamente il carico di lavoro.`,
                    ctaText: "Confronta: controllo diretto + carico ridotto",
                    benefits: [
                        "Meno burocrazia per la tua risorsa interna.",
                        "Nessuna scadenza mancata, zero errori.",
                        "Verbali e documenti pronti all'uso.",
                        "Gestione di fissi e stagionali senza problemi.",
                        "Formazione obbligatoria a costi ottimizzati."
                    ]
                },
                "gestisco-io": {
                    title: "Complimenti, hai tutto sotto controllo!",
                    text: `La tua azienda nel settore ${sectorName} sembra ben strutturata dal punto di vista della sicurezza.

Sapevi che nel tuo settore solo il <strong>10% delle aziende</strong> ha questo tipo di risultati con gestione diretta dell'imprenditore?

Spesso ciò che non viene detto è che fare un lavoro d'ufficio, invece di delegarlo a sistemi automatici, e stare dietro alle scadenze, gli attestati, le visite mediche e gli aggiornamenti normativi comporta diversi problemi:

• Perdite di tempo prezioso che potresti dedicare ad altro
• Potenziali multe e guai legali per semplici sviste o dimenticanze
• Perdite di opportunità di business mentre ti occupi di burocrazia
• Lo stress di dover ricordare ogni scadenza e adempimento

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per velocizzare i processi operativi</strong> mantenendo il controllo totale ma liberandoti dalla gestione quotidiana.`,
                    ctaText: "Confronta: controllo totale + tempo per il business",
                    benefits: [
                        "Più tempo per il tuo business, meno burocrazia.",
                        "Controllo totale senza perdere tempo operativo.",
                        "Sistema che lavora per te, anche di notte.",
                        "Crescita aziendale senza rischi normativi.",
                        "Automazione completa, decisioni sempre tue."
                    ]
                }
            };

            const template = excellenceTemplates[management];
            
            if (!template) {
                return {
                    title: "Complimenti, sei sulla strada giusta!",
                    text: `Dalle tue risposte emerge che la tua azienda nel settore ${sectorName} appare <strong>ben strutturata dal punto di vista della sicurezza</strong>. 

<strong>Al momento non abbiamo consigli specifici da darti</strong> perché sembri già essere seguito adeguatamente. Tuttavia, se vuoi, possiamo confrontare il tuo sistema attuale con il nostro per vedere se ci sono margini per <strong>semplificare alcuni processi o velocizzare le pratiche</strong>.`,
                    ctaText: "Scopri come ottimizzare ulteriormente",
                    benefits: [
                        "Processi ottimizzati senza stravolgimenti.",
                        "Controllo avanzato su conformità aziendale.",
                        "Supporto specialistico per casi complessi.",
                        "Crescita aziendale in piena sicurezza.",
                        "Automazione intelligente su misura."
                    ],
                    type: "success",
                    urgency: "low"
                };
            }

            return {
                title: template.title,
                text: template.text,
                ctaText: template.ctaText,
                benefits: template.benefits,
                type: "success",
                urgency: "low"
            };
        }

        function generateImprovementInsight(sector, management, violationCount) {
            const sectorPercentages = {
                edilizia: "68%",
                manifatturiero: "70%", 
                alimentare: "65%",
                trasporto: "72%",
                agricoltura: "60%",
                commercio: "58%",
                servizi: "55%",
                ristorazione: "63%"
            };

            const sectorNames = {
                edilizia: "di Edilizia",
                manifatturiero: "di Manifatturiero / Produzione", 
                alimentare: "di alloggio/ristorazione",
                trasporto: "di logistica",
                agricoltura: "di Agricoltura / Allevamento",
                commercio: "del commercio",
                servizi: "di Servizi / Uffici",
                ristorazione: "di Ristorazione / Commercio"
            };

            const sectorPercentage = sectorPercentages[sector] || "65%";
            const sectorName = sectorNames[sector] || "del tuo settore";

            const getAreaText = (count) => count === 1 ? "area di rischio" : "aree di rischio";

            const templates = {
                "studi-multipli": {
                    text: `La tua analisi mostra <strong>${violationCount} ${getAreaText(violationCount)}</strong>, le stesse che il <strong>${sectorPercentage} delle aziende</strong> nel settore ${sectorName.replace('di ', '').replace('del ', '').replace('dei ', '')} affronta.

<strong>Lavorare con più specialisti è un metodo valido</strong>, ma genera frammentazione:

• <strong>Quando le informazioni sono divise</strong>, il rischio di una scadenza mancata aumenta
• Ogni consulente conosce solo il suo pezzo del puzzle
• Le comunicazioni si perdono tra un professionista e l'altro
• <strong>Il risultato? Un sistema che ti espone a multe e ti fa perdere tempo</strong>

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per velocizzare i processi operativi</strong> mantenendo la specializzazione ma eliminando la frammentazione del coordinamento.`,
                    ctaText: "Scopri la cabina di regia per i tuoi consulenti",
                    benefits: [
                        "Unico sistema, zero frammentazione.",
                        "Scadenze sotto controllo, rischio azzerato.",
                        "Documenti sempre pronti per i controlli.",
                        "Nuovi assunti subito a norma, senza sforzi.",
                        "Formazione finanziata, costi ottimizzati."
                    ]
                },
                "consulente": {
                    text: `Dalle tue risposte emergono <strong>${violationCount} criticità</strong> che il <strong>${sectorPercentage} delle aziende</strong> nel settore ${sectorName.replace('di ', '').replace('del ', '').replace('dei ', '')} affronta.

<strong>Affidarsi a un consulente esterno è la scelta corretta</strong>, ma anche il professionista migliore può trovarsi in difficoltà:

• <strong>Senza un sistema di controllo centralizzato</strong> può rincorrere le informazioni
• Quando hai urgenza potrebbe non essere subito disponibile  
• <strong>Questo ti espone a ritardi e rischi inutili</strong>

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per ottimizzare i costi</strong> mantenendo la professionalità esterna ma con accesso immediato a tutto.`,
                    ctaText: "Scopri lo spazio condiviso per te e il tuo consulente",
                    benefits: [
                        "Pieno controllo per te e il tuo consulente.",
                        "Scadenze e adempimenti sempre rispettati.",
                        "Documentazione a prova di ispezione, 24/7.",
                        "Gestione del personale semplice e conforme.",
                        "Costi di formazione ridotti con i fondi."
                    ]
                },
                "interno": {
                    text: `La tua azienda presenta <strong>${violationCount} ${getAreaText(violationCount)}</strong>, comuni al <strong>${sectorPercentage} delle aziende</strong> nel settore ${sectorName.replace('di ', '').replace('del ', '').replace('dei ', '')}.

<strong>Avere una risorsa interna dedicata è molto vantaggioso</strong>, ma di fronte a un sistema normativo in continua evoluzione anche il collaboratore più preparato può trovarsi in difficoltà:

• <strong>Si rischia di perdere aggiornamenti cruciali</strong> mentre si gestisce l'operatività
• Quella persona è sempre in overload e rischia il burnout
• Ogni aggiornamento normativo diventa una corsa contro il tempo
• <strong>Un errore umano può costare molto caro all'azienda</strong>

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per velocizzare i processi operativi</strong> mantenendo il controllo diretto ma alleggerendo significativamente il carico di lavoro.`,
                    ctaText: "Scopri come potenziamo la tua risorsa interna",
                    benefits: [
                        "Meno burocrazia per la tua risorsa interna.",
                        "Nessuna scadenza mancata, zero errori.",
                        "Verbali e documenti pronti all'uso.",
                        "Gestione di fissi e stagionali senza problemi.",
                        "Formazione obbligatoria a costi ottimizzati."
                    ]
                },
                "gestisco-io": {
                    text: `La tua analisi evidenzia <strong>${violationCount} ${getAreaText(violationCount)}</strong> che interessano il <strong>${sectorPercentage} delle aziende</strong> nel settore ${sectorName.replace('di ', '').replace('del ', '').replace('dei ', '')}.

<strong>Gestire personalmente è una grande dimostrazione di competenza e attenzione</strong>, ma stare dietro a tutto comporta rischi:

• <strong>Perdite di tempo prezioso</strong> che potresti dedicare al business
• Rischio di dimenticanze che costano care in caso di controllo
• <strong>Lo stress di dover ricordare ogni scadenza da solo</strong>

Se vuoi, possiamo prenderci del tempo per un <strong>confronto sui margini per velocizzare i processi operativi</strong> mantenendo il controllo totale ma liberandoti dalla gestione quotidiana.`,
                    ctaText: "Scopri come mantenere il controllo risparmiando tempo",
                    benefits: [
                        "Più tempo per il tuo business, meno burocrazia.",
                        "Controllo totale senza perdere tempo operativo.",
                        "Sistema che lavora per te, anche di notte.",
                        "Crescita aziendale senza rischi normativi.",
                        "Automazione completa, decisioni sempre tue."
                    ]
                }
            };

            const template = templates[management];
            
            if (!template) {
                return {
                    title: "Analisi completata",
                    text: `La tua azienda presenta <strong>${violationCount} ${getAreaText(violationCount)}</strong> che richiedono attenzione. La situazione è migliorabile con le giuste azioni.`,
                    ctaText: "Scopri come migliorare",
                    benefits: [
                        "Conformità normativa garantita.",
                        "Rischi legali azzerati.",
                        "Processo semplificato e automatico.",
                        "Supporto professionale costante.",
                        "Tranquillità operativa totale."
                    ],
                    type: "analysis",
                    urgency: "medium"
                };
            }

            let urgency = "low";
            if (violationCount > 3) urgency = "high";
            else if (violationCount > 1) urgency = "medium";

            return {
                title: "Analisi personalizzata completata",
                text: template.text,
                ctaText: template.ctaText,
                benefits: template.benefits,
                type: "analysis",
                urgency: urgency
            };
        }

        // ========== UI FUNCTIONS ==========
        function showStage(stageName) {
            // Hide all stages
            document.getElementById('intro-stage').classList.add('hidden');
            document.getElementById('quiz-stage').classList.add('hidden');
            document.getElementById('loading-stage').classList.add('hidden');
            document.getElementById('results-stage').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            
            // Show target stage
            document.getElementById(stageName + '-stage').classList.remove('hidden');
            
            if (stageName === 'quiz') {
                document.getElementById('progress-container').classList.remove('hidden');
            }
            
            quizState.stage = stageName;
        }

        function updateProgress() {
            if (quizState.filteredQuestions.length === 0) return;
            
            const progress = (quizState.currentQuestionIndex / quizState.filteredQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function renderQuestion() {
            const question = quizState.filteredQuestions[quizState.currentQuestionIndex];
            if (!question) return;
            
            document.getElementById('question-number').textContent = 
                `Domanda ${quizState.currentQuestionIndex + 1} di ${quizState.filteredQuestions.length}`;
            document.getElementById('question-title').textContent = question.title;
            document.getElementById('question-subtitle').textContent = question.subtitle || '';
            
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            
            if (question.type === "select" || question.options.length > 3) {
                // Render as select dropdown
                const select = document.createElement('div');
                select.className = 'select';
                select.innerHTML = '<span>Seleziona una risposta</span><span>▼</span>';
                
                const content = document.createElement('div');
                content.className = 'select-content hidden';
                content.style.position = 'absolute';
                content.style.top = '100%';
                content.style.left = '0';
                content.style.right = '0';
                content.style.zIndex = '50';
                
                question.options.forEach(option => {
                    const item = document.createElement('div');
                    item.className = 'select-item';
                    item.textContent = option.label;
                    item.onclick = () => selectAnswer(option);
                    content.appendChild(item);
                });
                
                select.appendChild(content);
                select.onclick = () => content.classList.toggle('hidden');
                optionsContainer.appendChild(select);
                
            } else {
                // Render as buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';
                
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'button button-default w-full hover-scale';
                    button.textContent = option.label;
                    button.onclick = () => selectAnswer(option);
                    buttonContainer.appendChild(button);
                });
                
                optionsContainer.appendChild(buttonContainer);
            }
        }

        function selectAnswer(option) {
            const question = quizState.filteredQuestions[quizState.currentQuestionIndex];
            
            // Store answer
            quizState.answers[question.id] = option.value;
            
            // Update score/multiplier
            if (question.type === "score" && option.weight !== undefined) {
                quizState.baseScore += option.weight;
            } else if (question.type === "multiplier" && option.multiplier !== undefined) {
                quizState.multiplier *= option.multiplier;
            }
            
            // Move to next question or finish
            setTimeout(() => {
                quizState.currentQuestionIndex++;
                
                // Re-filter questions based on new answers
                quizState.filteredQuestions = filterQuestions(quizState.answers);
                
                if (quizState.currentQuestionIndex < quizState.filteredQuestions.length) {
                    renderQuestion();
                    updateProgress();
                } else {
                    finishQuiz();
                }
            }, APP_CONFIG.ui.transitionDelay);
        }

        function finishQuiz() {
            showStage('loading');
            
            // Simulate loading with progress
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                document.getElementById('loading-progress').style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    setTimeout(() => {
                        showResults();
                    }, 500);
                }
            }, 100);
        }

        function showResults() {
            const risk = calculateRisk(quizState.baseScore, quizState.multiplier);
            const violations = calculateViolations(quizState.answers);
            const insight = generateDynamicInsight(quizState.answers, violations);
            
            renderResults(risk, violations, insight);
            showStage('results');
        }

        function renderResults(risk, violations, insight) {
            const resultsContainer = document.getElementById('results-stage');
            
            const sanctionMax = violations.reduce((total, v) => total + v.max, 0);
            const violationsCount = violations.length;
            
            const heroMessage = getHeroMessage(risk, violations, sanctionMax);
            
            let resultsHTML = `
                <!-- Primary Risk Card -->
                <div class="card border-2 border-red-600 shadow-xl bg-white">
                    <div class="card-content p-6">
                        <div class="text-center">
                            ${violationsCount > 0 ? `
                                <div class="inline-flex items-center px-6 py-3 rounded-full mb-2 ${
                                    risk.level === 'Alto' ? 'bg-red-100 text-red-800 border-2 border-red-300' :
                                    risk.level === 'Medio' ? 'bg-orange-100 text-orange-800 border-2 border-orange-300' :
                                    'bg-yellow-100 text-yellow-800 border-2 border-yellow-300'
                                }">
                                    <span class="font-bold text-base">RISCHIO ${risk.level.toUpperCase()}</span>
                                </div>
                                <div class="text-sm text-gray-600 font-medium mb-4">
                                    ${heroMessage.message}
                                </div>
                            ` : `
                                <div class="inline-flex items-center px-6 py-3 rounded-full mb-2 bg-green-100 text-green-800 border-2 border-green-300">
                                    <span class="font-bold text-base">✅ COMPLIMENTI!</span>
                                </div>
                            `}
                            
                            <div class="text-2xl font-bold mb-6 ${violationsCount === 0 ? 'text-black' : 'text-red-600'}">
                                ${violationsCount === 0 ? 
                                    '<div>La tua azienda rispetta</div><div>le norme di sicurezza</div>' : 
                                    heroMessage.subtitle
                                }
                            </div>

                            ${violationsCount === 0 ? `
                                <div class="text-base text-red-600 font-medium">
                                    ${heroMessage.message}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Dynamic Insights Box -->
                ${renderInsightBox(insight)}

                <!-- CTA Section -->
                ${violationsCount > 0 ? `
                    <div class="bg-gray-800 text-white p-4 rounded-lg text-center">
                        <p class="text-sm mb-3 font-medium">
                            Non aspettare l'ispezione, risolviamo insieme ogni criticità. Prenota ora una consulenza gratuita.
                        </p>
                        <button onclick="openWhatsApp('${risk.level}', '${quizState.answers.settore || ''}', ${violationsCount})" 
                                class="button button-cta px-6 py-2 text-sm font-semibold">
                            → Parliamone su WhatsApp
                        </button>
                    </div>
                ` : ''}

                <!-- Violations Detail -->
                ${violationsCount > 0 ? renderViolationsDetail(violations) : ''}

                <!-- Benefits Section -->
                ${insight.benefits ? renderBenefitsSection(insight.benefits, violationsCount > 0) : ''}

                <!-- Case Studies -->
                ${renderCaseStudies()}

                <!-- Bridge CTA -->
                ${renderBridgeCTA(risk, violations)}

                <!-- Contact CTA -->
                ${renderContactCTA(risk)}

                <!-- FAQ Section -->
                ${renderFAQ()}

                <!-- Reset Button -->
                <div class="text-center mt-6">
                    <button onclick="resetQuiz()" class="button button-ghost">
                        Rifai il test per un'altra azienda
                    </button>
                </div>
            `;
            
            resultsContainer.innerHTML = resultsHTML;
        }

        function getHeroMessage(risk, violations, sanctionMax) {
            if (violations.length === 0) {
                return {
                    title: "✅ COMPLIMENTI!",
                    subtitle: "La tua azienda rispetta le norme di sicurezza",
                    message: "Ma stai sfruttando tutte le opportunità per eccellere nel tuo settore?",
                    ctaText: "🚀 ANALISI STRATEGICA GRATUITA",
                    ctaSubtext: "Ottimizza per diventare un'eccellenza"
                };
            }

            const mostSevereConsequence = violations
                .flatMap(v => v.consequences)
                .find(c => c.toLowerCase().includes('sospensione') || c.toLowerCase().includes('blocco')) ||
                violations.flatMap(v => v.consequences)
                    .find(c => c.toLowerCase().includes('denuncia') || c.toLowerCase().includes('penale')) ||
                violations[0]?.consequences[0] || "possibili sanzioni amministrative";

            const consequenceText = mostSevereConsequence.toLowerCase().includes('sospensione') ? 
                "la sospensione dell'attività" :
                mostSevereConsequence.toLowerCase().includes('blocco') ?
                "il blocco dell'attività" :  
                mostSevereConsequence.toLowerCase().includes('denuncia') ?
                "possibili denunce penali" :
                "gravi conseguenze amministrative";

            const mainViolationType = violations[0]?.key;
            const violationContext = 
                mainViolationType === 'dvr' ? "gravi violazioni DVR" :
                mainViolationType === 'formazione' ? "violazioni formative" :
                mainViolationType === 'gestione' ? "violazioni gestionali" :
                "violazioni normative";

            return {
                title: `⚠️ RISCHIO ${risk.level.toUpperCase()}`,
                subtitle: `Rischi fino a €${sanctionMax.toLocaleString("it-IT")} di sanzioni e ${consequenceText}`,
                message: `in caso di ispezione con ${violationContext}`,
                ctaText: "🎯 ANALISI GRATUITA - 15 MIN",
                ctaSubtext: risk.level === "Alto" ? "Metti subito in sicurezza la tua azienda" :
                           risk.level === "Medio" ? "Risolvi le criticità prima che sia tardi" :
                           "Completa la messa a norma definitiva"
            };
        }

        function renderInsightBox(insight) {
            return `
                <div class="card border border-gray-300 shadow-lg bg-white">
                    <div class="card-header border-b border-gray-200">
                        <h3 class="text-xl font-bold">${escapeOutput(insight.title)}</h3>
                    </div>
                    <div class="card-content">
                        <div class="text-base leading-relaxed mb-4">
                            ${insight.text}
                        </div>
                        ${insight.ctaText ? `
                            <div class="text-center">
                                <button onclick="scrollToContact()" 
                                        class="button button-cta px-6 py-3 font-bold hover-scale transition-all">
                                    ${escapeOutput(insight.ctaText)}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderViolationsDetail(violations) {
            return `
                <div class="card border border-gray-300 shadow-lg bg-white">
                    <div class="card-header pb-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-black">Dettaglio Rischi e Soluzioni</h3>
                        <p class="text-sm text-gray-500 mt-1">(clicca sulle opzioni per approfondire)</p>
                    </div>
                    <div class="card-content space-y-3">
                        ${violations.map((v, index) => `
                            <details class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden transition-all hover:shadow-md">
                                <summary class="p-4 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition-colors">
                                    <div class="flex items-center gap-2 flex-1 min-w-0 overflow-hidden">
                                        <span class="flex-shrink-0 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                            ✕
                                        </span>
                                        <span class="font-semibold text-base truncate whitespace-nowrap overflow-hidden text-ellipsis">${escapeOutput(v.text)}</span>
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        <span class="badge badge-destructive text-xs whitespace-nowrap">${escapeOutput(v.priority.urgency)}</span>
                                        <span class="text-gray-400 transition-transform flex-shrink-0">▼</span>
                                    </div>
                                </summary>
                                <div class="p-4 border-t bg-white">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                                            <h4 class="font-bold text-sm mb-2">⚠️ Rischi</h4>
                                            <ul class="text-sm space-y-1">
                                                ${v.consequences.map(c => `
                                                    <li class="flex items-start">
                                                        <span class="text-red-500 mr-1">•</span>
                                                        <span>${escapeOutput(c)}</span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                        <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                                            <h4 class="font-bold text-sm mb-2">✅ Azioni</h4>
                                            <ul class="text-sm space-y-1">
                                                ${v.actions.map(a => `
                                                    <li class="flex items-start">
                                                        <span class="text-green-500 mr-1">•</span>
                                                        <span>${escapeOutput(a)}</span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-600 pt-2 mt-3 border-t">
                                        <strong>📖 Normativa:</strong> ${escapeOutput(v.fonte)}
                                    </div>
                                </div>
                            </details>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderBenefitsSection(benefits, hasViolations) {
            return `
                <div class="card border-2 border-black shadow-xl bg-gradient-to-br from-gray-900 to-black text-white">
                    <div class="card-header border-b border-gray-700">
                        <h3 class="text-xl font-bold text-white">
                            ${hasViolations ? 
                                "Cosa ottieni con il Sistema Organizzativo di Spazio Impresa" : 
                                "Vantaggi dell'ottimizzazione con Spazio Impresa"}
                        </h3>
                        <p class="text-sm text-gray-300 mt-2">
                            ${hasViolations ? 
                                "(dopo l'attivazione del servizio)" : 
                                "(mantenendo ciò che già funziona)"}
                        </p>
                    </div>
                    <div class="card-content">
                        <div class="grid gap-4">
                            ${benefits.map((benefit, index) => `
                                <div class="flex items-start gap-3 p-3 bg-white/10 rounded-lg backdrop-blur-sm hover:bg-white/20 transition-colors border border-white/20">
                                    <span class="text-xl">•</span>
                                    <span class="text-base">${benefit}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCaseStudies() {
            return `
                <div class="card border border-gray-300 shadow-lg bg-white">
                    <div class="card-header border-b border-gray-200">
                        <h3 class="text-xl font-bold">📋 Casi di Studio Reali</h3>
                        <p class="text-sm text-gray-600 mt-1">Scopri come abbiamo aiutato aziende come la tua</p>
                    </div>
                    <div class="card-content">
                        <div class="space-y-6">
                            ${CASE_STUDIES.map(study => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">${study.icon}</span>
                                        <div>
                                            <h4 class="font-bold text-lg">${escapeOutput(study.title)}</h4>
                                            <p class="text-sm text-gray-600">${escapeOutput(study.situation)}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                        <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                                            <h5 class="font-bold text-sm mb-2">⚠️ La Situazione</h5>
                                            <div class="text-sm">${study.challenge}</div>
                                        </div>
                                        
                                        <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                                            <h5 class="font-bold text-sm mb-2">✅ La Soluzione</h5>
                                            <ul class="text-sm space-y-1">
                                                ${study.solution.map(sol => `
                                                    <li class="flex items-start">
                                                        <span class="text-green-500 mr-1">•</span>
                                                        <span>${sol}</span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded">
                                        <h5 class="font-bold text-sm mb-1">🎯 Il Risultato</h5>
                                        <p class="text-sm">${study.result}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBridgeCTA(risk, violations) {
            const benefit = getDynamicBenefit(violations);
            const bridgeQuestion = `Vuoi anche tu questo tipo di risultati? Scopri come ${benefit}`;
            
            return `
                <div class="bg-gradient-to-br from-gray-900 to-black text-white rounded-lg p-4 text-center shadow-xl border-2 border-black">
                    <h2 class="text-base font-semibold mb-3">
                        ${escapeOutput(bridgeQuestion)}
                    </h2>
                    <div class="flex justify-center">
                        <div class="text-lg animate-bounce">↓</div>
                    </div>
                </div>
            `;
        }

        function renderContactCTA(risk) {
            return `
                <div id="contact-cta" class="card border-2 border-black shadow-xl bg-white">
                    <div class="card-content text-center">
                        <h3 class="text-2xl font-bold mb-4">🎯 ANALISI STRATEGICA GRATUITA</h3>
                        <p class="text-lg mb-6">
                            Prenota una chiamata di 15 minuti per ricevere il confronto costi-benefici personalizzato 
                            e vedere esattamente come eliminare ogni rischio della tua azienda.
                        </p>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-green-800 mb-2">🔒 Cosa ricevi:</h4>
                            <ul class="text-sm text-green-700 text-left space-y-1">
                                <li>✅ Piano d'azione personalizzato per la tua azienda</li>
                                <li>✅ Cronoprogramma delle priorità da rispettare</li>
                                <li>✅ Calcolo preciso dei costi di non conformità</li>
                                <li>✅ Confronto tra i costi dell'inazione vs soluzione</li>
                                <li>✅ Zero impegno, massima trasparenza</li>
                            </ul>
                        </div>
                        
                        <button onclick="openWhatsAppDetailed('${risk.level}')" 
                                class="button button-cta w-full py-4 text-lg font-bold hover-scale mb-3">
                            📞 PRENOTA CHIAMATA GRATUITA
                        </button>
                        
                        <p class="text-xs text-gray-600">
                            ⏰ Disponibile dal lunedì al venerdì, 9:00-18:00<br>
                            📱 Risposta garantita entro 2 ore lavorative
                        </p>
                    </div>
                </div>
            `;
        }

        function renderFAQ() {
            const faqs = [
                {
                    question: "Quanto costa il servizio di Spazio Impresa?",
                    answer: "I nostri servizi partono da €89/mese per le aziende fino a 10 dipendenti. Il costo varia in base al settore e al numero di dipendenti. Durante la consulenza gratuita ti forniremo un preventivo personalizzato trasparente, senza costi nascosti."
                },
                {
                    question: "Quanto tempo serve per essere completamente a norma?",
                    answer: "Dipende dalla situazione di partenza. In genere: per documentazione urgente (DVR, nomine) 48-72 ore; per formazione completa 15-30 giorni; per visite mediche 7-15 giorni. Ti forniamo un cronoprogramma dettagliato."
                },
                {
                    question: "Cosa succede se arriva un controllo durante l'adeguamento?",
                    answer: "Ti affianchiamo direttamente durante l'ispezione. Abbiamo un protocollo specifico per gestire i controlli in corso di adeguamento, minimizzando sanzioni e dimostrando agli ispettori la buona fede dell'azienda."
                },
                {
                    question: "Il test è davvero gratuito? Ci sono costi nascosti?",
                    answer: "Il test è completamente gratuito, come la prima consulenza di 15 minuti. Non ci sono costi nascosti. Ti proporremo un servizio solo se serve davvero e solo dopo aver analizzato insieme la tua situazione."
                },
                {
                    question: "Lavorate in tutta Italia?",
                    answer: "Siamo basati in Sicilia ma lavoriamo in tutta Italia. Per la consulenza usiamo videochiamate, per documenti e formazione tutto è online. Per le visite mediche abbiamo una rete di medici competenti convenzionati in ogni regione."
                }
            ];

            return `
                <div class="card border border-gray-300 shadow-lg bg-white">
                    <div class="card-header border-b border-gray-200">
                        <h3 class="text-xl font-bold">❓ Domande Frequenti</h3>
                    </div>
                    <div class="card-content">
                        <div class="space-y-4">
                            ${faqs.map((faq, index) => `
                                <div class="accordion-item">
                                    <button class="accordion-trigger" onclick="toggleAccordion('faq-${index}')">
                                        <span class="font-medium">${escapeOutput(faq.question)}</span>
                                        <span id="faq-${index}-icon" class="text-gray-400 transition-transform">▼</span>
                                    </button>
                                    <div id="faq-${index}" class="accordion-content" style="height: 0;">
                                        <div class="accordion-content-inner">
                                            ${faq.answer}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function getDynamicBenefit(violations) {
            if (violations.length === 0) {
                return "ottimizzare la tua struttura già solida e diventare un esempio di eccellenza nel settore";
            }

            const primaryViolation = violations[0];
            
            const benefitMap = {
                dvr: "eliminare il rischio sospensione e proteggere la tua azienda da potenziali denunce penali",
                formazione: "azzerare la responsabilità penale e rendere il tuo team perfettamente formato e operativo",
                sorveglianza: "garantire che tutti i dipendenti siano sempre idonei al lavoro senza rischi legali",
                figure_spp: "avere tutte le figure di sicurezza nominate e operative per una protezione totale",
                emergenze: "essere preparati a qualsiasi emergenza con procedure certificate e testate",
                gestione: "creare un sistema di sicurezza che funziona da solo e ti fa dormire sonni tranquilli"
            };

            return benefitMap[primaryViolation.key] || "trasformare le tue criticità in punti di forza competitivi";
        }

        // ========== EVENT HANDLERS ==========
        function startQuiz() {
            if (!validateCSRF() || !rateLimit()) {
                alert('Errore di sicurezza. Riprova più tardi.');
                return;
            }
            
            quizState.filteredQuestions = filterQuestions(quizState.answers);
            showStage('quiz');
            renderQuestion();
            updateProgress();
        }

        function resetQuiz() {
            quizState = {
                stage: "intro",
                currentQuestionIndex: 0,
                answers: {},
                baseScore: 0,
                multiplier: 1,
                filteredQuestions: []
            };
            showStage('intro');
        }

        function openWhatsApp(riskLevel, sector, violationCount) {
            let message = `Ciao Spazio Impresa! Ho completato il test di conformità. `;
            const violationText = riskLevel === "Alto" ? "multiple criticità" : "alcune criticità";
            const sectorText = sector ? ` nel settore ${getSectorName(sector)}` : '';
            message += `Risultato: rischio ${riskLevel} con ${violationText} rilevate${sectorText}. `;
            message += `Vorrei prenotare l'Analisi Strategica Gratuita per vedere il confronto costi-benefici e capire come eliminare questi rischi.`;
            
            const text = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/+${APP_CONFIG.contact.whatsapp}?text=${text}`;
            window.open(whatsappUrl, '_blank');
        }

        function openWhatsAppDetailed(riskLevel) {
            const message = `Ciao Spazio Impresa! Ho completato il vostro test di conformità sicurezza lavoro. Risultato: rischio ${riskLevel}. Vorrei prenotare la chiamata gratuita di 15 minuti per ricevere l'analisi strategica personalizzata e il confronto costi-benefici. Quando siete disponibili?`;
            
            const text = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/+${APP_CONFIG.contact.whatsapp}?text=${text}`;
            window.open(whatsappUrl, '_blank');
        }

        function scrollToContact() {
            document.getElementById('contact-cta').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            
            if (content.style.height === '0px' || content.style.height === '') {
                content.style.height = content.scrollHeight + 'px';
                icon.classList.add('rotate-180');
            } else {
                content.style.height = '0px';
                icon.classList.remove('rotate-180');
            }
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize quiz
            document.getElementById('start-quiz').onclick = startQuiz;
            
            // Add CSP headers for security
            const meta = document.createElement('meta');
            meta.httpEquiv = 'Content-Security-Policy';
            meta.content = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';";
            document.head.appendChild(meta);
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.style.display = 'none';
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingDiv.innerHTML = '<div class="bg-white p-4 rounded">Caricamento...</div>';
            document.body.appendChild(loadingDiv);
            
            console.log('Quiz di Sicurezza Lavoro inizializzato - Versione:', APP_CONFIG.version);
        });

        // Add error handling
        window.addEventListener('error', function(e) {
            console.error('Errore nell\'applicazione:', e.error);
            // Send error to WordPress error logging if available
            if (typeof wp !== 'undefined' && wp.ajax) {
                wp.ajax.post('log_quiz_error', {
                    error: e.error.toString(),
                    url: window.location.href,
                    userAgent: navigator.userAgent
                });
            }
        });

        // Add beforeunload handler for analytics
        window.addEventListener('beforeunload', function() {
            if (typeof wp !== 'undefined' && wp.ajax && quizState.stage !== 'intro') {
                wp.ajax.post('track_quiz_exit', {
                    stage: quizState.stage,
                    progress: quizState.currentQuestionIndex,
                    answers: Object.keys(quizState.answers).length
                });
            }
        });
    </script>
</body>
</html>